# https://github.com/2dof/esp_control
#The MIT License (MIT), Copyright (c) 2022-2023 L.Szydlowski
# __version__   = "1.0.0"


import array
from lookup_search import idx_search
from benchmark import timed_function
#import gc

#gc.collect()
#start = gc.mem_free()
ITS90_EK=array.array('H',[    0,    17,    54,   114,   195,   300,   423,   567,   727,
         908,  1104,  1317,  1545,  1789,  2046,  2320,  2606,  2904,
        3215,  3538,  3871,  4215,  4569,  4931,  5302,  5680,  6066,
        6458,  6855,  7256,  7661,  8070,  8481,  8894,  9309,  9725,
       10140, 10554, 10966, 11378, 11786, 12193, 12596, 12998, 13399,
       13798, 14197, 14596, 14997, 15398, 15801, 16204, 16610, 17019,
       17429, 17840, 18253, 18667, 19082, 19497, 19915, 20332, 20750,
       21171, 21591, 22012, 22433, 22855, 23278, 23701, 24125, 24549,
       24973, 25399, 25823, 26250, 26676, 27102, 27528, 27955, 28381,
       28808, 29234, 29661, 30087, 30512, 30938, 31363, 31787, 32213,
       32637, 33059, 33483, 33905, 34327, 34747, 35168, 35587, 36006,
       36423, 36839, 37256, 37671, 38086, 38498, 38911, 39323, 39733,
       40143, 40551, 40958, 41366, 41771, 42176, 42579, 42982, 43382,
       43784, 44183, 44582, 44980, 45376, 45772, 46166, 46559, 46952,
       47343, 47734, 48123, 48511, 48897, 49284, 49669, 50053, 50436,
       50816, 51198, 51577, 51955, 52331, 52706, 53081, 53452, 53824,
       54194, 54562, 54931, 55296, 55660, 56022, 56384, 56744, 57102,
       57458, 57812, 58166, 58518, 58867, 59216, 59564, 59909, 60253,
       60596, 60937, 61276])
#print(start - gc.mem_free())




@timed_function
def its90_K_lookup(E,low=0, high=163):    
    
    Ei = E +6458 # 'shift ITS90_EK ranges

    idx = idx_search(ITS90_EK, low,high, Ei)
    
    if idx ==-1:
       idx =163
       if E < 0:
          idx=0
    
    a=10/(ITS90_EK[idx+1]-ITS90_EK[idx])
    y= a*(Ei-ITS90_EK[idx])+idx*10-270
 
    return (y,idx)

if __name__ == '__main__':

    #E = 54886  #->1373 C
    E = 48838   # ->1200 C
    E = 37725   # 910
    #E = 32289   # 776
    #E = 32041   # 770
    #E = 27658   # 665
    #E = 24905   # 600
    #E = 22990   # 555
    #E = 20644   # 500 C
    E = 10153    # 250 
    E = 1000    # 25 C 
    E = 397     # 10 
    E = -3852   # - 110   
    E = -6458   # -270 

    E=[-6458,-3852 ,397 ,1000,10153,20644,22990,24905,27658,32041,32289,37725,48838, 54886] # [uV]
    Tref = [-270,- 110,10, 25,250,500,555, 600, 665, 770,776, 910,1200,1373] # [C]
    
    for i in range(len(E)):
        T,idx = its90_K_lookup(E[i])
        #print(T)
    
    
    #T,idx = its90_K_lookup(E,idx-1,idx+1)
    #print(T)